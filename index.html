<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>예비품 재고 관리</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    
/* 로그인 화면 스타일 */
#login-overlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #f8fafc; display: flex; align-items: center; justify-content: center;
  z-index: 9999; /* 모든 화면보다 위에 표시 */
}
.login-box {
  background: white; padding: 30px; border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 320px; text-align: center;
}
.login-box h2 { margin-bottom: 20px; color: #1e3a8a; }
.login-box input { width: 100%; margin-bottom: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
.login-box button { width: 100%; padding: 12px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; }
.login-box button:hover { background: #1d4ed8; }
    
    /* 1. 전체 레이아웃 */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f5f7fb;
      padding: 20px;
      color: #111827;
      line-height: 1.5;
    }

    /* 2. 헤더 영역 */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }
    .header .title h2 { margin: 0; font-size: 22px; }
    .header .title span { font-size: 13px; color: #6b7280; }
    .company img { height: 60px; }

    /* 3. 입력 창 및 버튼 */
    h3 {
      margin-top: 30px;
      border-left: 5px solid #2563eb;
      padding-left: 10px;
      margin-bottom: 15px;
    }
    input, select {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      margin: 5px 5px 5px 0;
      min-width: 150px;
    }
    button {
      padding: 8px 14px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #1e40af; }
    hr { border: none; border-top: 1px solid #e5e7eb; margin: 30px 0; }

    /* 4. 핵심: 테이블 스크롤 박스 (틀 고정의 핵심) */
    .table-wrapper {
      max-height: 600px;    /* 표의 최대 높이 */
      overflow-y: auto;     /* 세로 스크롤 */
      overflow-x: auto;     /* 가로 스크롤 */
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      position: relative;   /* 내부 sticky 요소의 기준 */
    }

    table {
      width: 100%;
      border-collapse: separate; /* sticky가 작동하려면 separate여야 함 */
      border-spacing: 0;         /* 간격은 0 */
    }

    /* 5. 핵심: 엑셀 틀 고정 (헤더 고정) */
    thead th {
      position: sticky;
      top: 0;               /* 최상단 고정 */
      background: #f8fafc;  /* 배경색 필수 (아래 데이터 가림용) */
      z-index: 10;
      font-weight: bold;
      padding: 12px 10px;
      border-bottom: 2px solid #cbd5e1; /* 헤더 아래쪽 선 */
      border-right: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;  /* 제목 줄바꿈 방지 */
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      border-right: 1px solid #e5e7eb;
      text-align: left;
    }

    /* 재고가 0개일 때 (아주 옅은 노란색) */
    .low-stock {
        background-color: #fffbeb !important; /* 아주 연한 파스텔 노란색 */
    }

    /* 행 구분을 위해 아래쪽 선을 조금 더 명확하게 설정 */
    .low-stock td {
        border-bottom: 1px solid #fef3c7 !important;
    }

    /* 마우스 올렸을 때 색상 */
    tbody tr.low-stock:hover {
          background-color: #fef3c7 !important;
    }
    
    /* 마지막 열 선 제거 */
    th:last-child, td:last-child { border-right: none; }



    
/* 제목 줄 클릭 가능 표시 */
thead th {
  cursor: pointer;
  user-select: none; /* 드래그 방지 */
}

thead th:hover {
  background-color: #f1f5f9; /* 마우스 올리면 살짝 어둡게 */
}



    
/* 정렬 화살표 표시를 위한 스타일 */
.sort-asc::after { content: " ▲"; font-size: 10px; }
.sort-desc::after { content: " ▼"; font-size: 10px; }

    
    /* 행 하이라이트 */
    tbody tr:hover { background: #f1f5f9; }

    /* 입출고 색상 */
    .type-in { color: #2563eb; font-weight: bold; }
    .type-out { color: #dc2626; font-weight: bold; }
  </style>
</head>
<body>

<div id="login-overlay">
  <div class="login-box">
    <h2>재고관리 로그인</h2>
    <input type="text" id="login-id" placeholder="아이디를 입력하세요" />
    <input type="password" id="login-pw" placeholder="비밀번호를 입력하세요" />
    <button onclick="checkLogin()">로그인</button>
    <p id="login-msg" style="color: red; font-size: 13px; margin-top: 10px;"></p>
  </div>
</div>  

  
<div class="header">
  <div class="title">
    <h2>예비품 재고 관리</h2>
    <span>환경바이오 사업소</span>
  </div>
  <div class="company">
    <img src="logo.jpg" alt="회사 로고">
  </div>
</div>

<h3>입고</h3>
<select id="main_category" onchange="updateMidCategory()"><option value="">대분류 선택</option></select>
<select id="mid_category"><option value="">중분류 선택</option></select>
<input id="part_name" placeholder="예비품명" />
<input id="quantity" type="number" placeholder="수량" />
<input id="storage_location" placeholder="보관 위치" />
<input id="note" placeholder="비고" />
<button onclick="savePart()">입고 저장</button>

<hr />

<h3>출고</h3>
<select id="out_part_id"><option value="">출고 예비품 선택</option></select>
<input id="out_quantity" type="number" placeholder="출고 수량" />
<input id="out_note" placeholder="비고" />
<button onclick="outPart()">출고 처리</button>

<hr />

<h3>현재 재고</h3>
<div style="margin-bottom: 15px;">
  <input id="search" placeholder="예비품명으로 재고 검색..." style="margin: 0 5px 0 0; width: 250px;" />
  <button onclick="loadParts()">조회</button>
  <button onclick="resetSearch()" style="background: #6b7280;">초기화</button>
  <button onclick="downloadExcel('list', '현재재고현황')" style="background: #16a34a; margin-left: 10px;">엑셀 저장</button>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th onclick="sortTable('list', 0)">대분류</th>
        <th onclick="sortTable('list', 1)">중분류</th>
        <th onclick="sortTable('list', 2)">예비품명</th>
        <th onclick="sortTable('list', 3, true)">수량</th>
        <th onclick="sortTable('list', 4)">보관위치</th>
        <th onclick="sortTable('list', 5)">비고</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>
</div> <hr />

<h3>입·출고 통합 이력</h3>
<div style="margin-bottom: 15px;">
  <input type="date" id="start_date" /> ~ 
  <input type="date" id="end_date" />
  <button onclick="loadAllLogs()">필터 적용</button>
  <button onclick="resetLogFilter()" style="background: #6b7280;">초기화</button>
  <button onclick="downloadExcel('all_log_list', '입출고통합이력')" style="background: #16a34a; margin-left: 10px;">엑셀 저장</button>
</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th onclick="sortTable('all_log_list', 0)">일시</th>
        <th onclick="sortTable('all_log_list', 1)">구분</th>
        <th onclick="sortTable('all_log_list', 2)">대분류</th>
        <th onclick="sortTable('all_log_list', 3)">중분류</th>
        <th onclick="sortTable('all_log_list', 4)">예비품명</th>
        <th onclick="sortTable('all_log_list', 5, true)">수량</th>
        <th onclick="sortTable('all_log_list', 6)">비고</th>
      </tr>
    </thead>
    <tbody id="all_log_list"></tbody>
  </table>
</div> 
  
<script>
/* ===== Supabase 연결 ===== */
const SUPABASE_URL = "https://tgkwhchuoxuvitnsaqjo.supabase.co";
const SUPABASE_KEY = "sb_publishable_EhWgQhfjCTAdrWTQRUPYKg_c-UU2m2y";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== 분류 데이터 ===== */
const CATEGORIES = {
  "반입및전처리설비": ["반입장", "호퍼 자동개폐기", "음식물 배출컨베이어", "음식물 이송컨베이어", "음식물 공급컨베이어", "협잡물 이송컨베이어", "1차 파쇄기", "가용화조", "가용화조 블로워", "음폐수저장조#A", "음폐수저장조#B", "음폐수저장조 교반기", "중간저장조", "중간저장조 교반기", "슬러리 이송펌프", "음폐수 이송펌프", "유압유니트", "드럼스크린", "드럼스크린 테이퍼스크류", "회전분쇄공급기", "미세분쇄기"],
  "혐기성소화설비": ["혐기성소화조", "가스저장조", "안정화조", "안정화조 교반기", "임펄스펌프", "소화슬러지 이송펌프", "소화액반송펌프", "열교환순환펌프", "침전물배출펌프", "가온순환펌프", "공기압축기"],
  "소화가스이용설비": ["가스정제설비", "제습장치", "워터트랩", "공급가스이송블로워", "가스압축기", "부취제 설비", "냉각설비", "냉각수 순환펌프", "소화가스 완충탱크", "소화가스 저장탱크", "보일러", "잉여가스연소기", "승압블로워", "수요처 가스이송"],
  "소화슬러지설비": ["슬러지저장조", "슬러지저장조 교반기", "슬러지 이송펌프", "슬러지 공급펌프", "응집반응조", "탈수기", "가압부상조", "가압순환펌프", "폴리머 설비"],
  "폐수처리설비": ["유량조정조", "유량조정조 교반기", "유량조정조 이송펌프", "유량조정조 바이패스펌프", "UMBR조", "BFS 침전조", "처리수조", "처리수 이송펌프", "질산화조", "질산화조 송풍기", "연계처리수조", "연계처리수조 교반기", "연계처리수 이송펌프", "수충격방지설비", "스컴저장조", "스컴이송펌프", "잉여슬러지 인발펌프", "내부반송펌프", "슬러지 반송펌프", "열교환기", "냉각설비", "냉각순환펌프", "폐수약품설비", "가압부상조"],
  "악취제거설비": ["고농도 탈취기", "고농도 탈취팬", "고농도 순환펌프", "중저농도 탈취기", "중저농도 탈취팬", "중저농도 순환펌프", "RTO 설비"],
  "기타설비": ["공정수조", "지하수조", "소방수조", "공정수 부스터 펌프", "지하수 부스터 펌프", "소방펌프", "소방설비", "압롤박스실", "SUMP#1", "SUMP#2", "SUMP#3", "SUMP#4", "SUMP#5", "SUMP#6", "기계설비실", "배수로", "시설동", "소화동", "비상저류조", "기타"]
};

function loadMainCategory() {
  for (const k in CATEGORIES) {
    main_category.innerHTML += `<option value="${k}">${k}</option>`;
  }
}

function updateMidCategory() {
  mid_category.innerHTML = '<option value="">중분류 선택</option>';
  if (!main_category.value) return;
  CATEGORIES[main_category.value].forEach(m => {
    mid_category.innerHTML += `<option value="${m}">${m}</option>`;
  });
}

/* ===== 기능 로직 ===== */

async function loadParts() {
  const keyword = search.value;
  let q = sb.from("spare_parts").select("*").order("part_name", { ascending:true });
  if (keyword) q = q.ilike("part_name", `%${keyword}%`);

  const { data } = await q;
  list.innerHTML = "";
  
  data.forEach(r => {
    // [중요] 재고가 1개 미만이면 'low-stock'이라는 이름을 붙여줍니다.
    const lowStockClass = r.quantity < 1 ? "low-stock" : "";

    list.innerHTML += `
      <tr class="${lowStockClass}">
        <td>${r.main_category}</td>
        <td>${r.mid_category}</td>
        <td>${r.part_name}</td>
        <td>${r.quantity}</td>
        <td>${r.location}</td>
        <td>${r.note ?? ""}</td>
      </tr>`;
  });
}

  
async function savePart() {
  const mCat = main_category.value;
  const sCat = mid_category.value;
  const pName = part_name.value.trim();
  const qty = Number(quantity.value);
  const loc = storage_location.value.trim();
  const memo = note.value.trim();

  if (!pName || qty <= 0) return alert("품목명과 수량을 입력하세요.");

  // 기존 품목 확인
  const { data: found } = await sb.from("spare_parts").select("*").eq("part_name", pName).eq("main_category", mCat);
  const existing = found && found.length > 0 ? found[0] : null;

  let tid;
  if (existing) {
    const { error } = await sb.from("spare_parts").update({ quantity: existing.quantity + qty, location: loc, note: memo }).eq("id", existing.id);
    if (error) return alert(error.message);
    tid = existing.id;
  } else {
    const { data: newP, error } = await sb.from("spare_parts").insert([{ main_category: mCat, mid_category: sCat, part_name: pName, quantity: qty, location: loc, note: memo }]).select().single();
    if (error) return alert(error.message);
    tid = newP.id;
  }

  await sb.from("spare_parts_logs").insert([{ part_id: tid, type: "IN", quantity: qty, main_category: mCat, mid_category: sCat, part_name: pName, note: memo }]);

  alert("입고 완료");
  part_name.value = ""; quantity.value = "";
  loadParts(); loadOutParts(); loadAllLogs();
}

async function loadOutParts() {
  out_part_id.innerHTML = '<option value="">출고 예비품 선택</option>';
  const { data } = await sb.from("spare_parts").select("*").gt("quantity", 0).order("part_name", {ascending: true});
  data.forEach(p => {
    out_part_id.innerHTML += `<option value="${p.id}">${p.part_name} (${p.main_category}) [재고:${p.quantity}]</option>`;
  });
}

async function outPart() {
  const id = Number(out_part_id.value);
  const qty = Number(out_quantity.value);
  if (!id || qty <= 0) return alert("항목과 수량을 확인하세요.");

  const { data: stock } = await sb.from("spare_parts").select("*").eq("id", id).single();
  if (stock.quantity < qty) return alert("재고 부족");

  await sb.from("spare_parts").update({ quantity: stock.quantity - qty }).eq("id", id);
  await sb.from("spare_parts_logs").insert([{ part_id: id, type: "OUT", quantity: qty, main_category: stock.main_category, mid_category: stock.mid_category, part_name: stock.part_name, note: out_note.value }]);

  alert("출고 완료");
  out_quantity.value = "";
  loadParts(); loadOutParts(); loadAllLogs();
}

/* 입·출고 통합 이력 조회 (날짜 필터 기능 포함) */
async function loadAllLogs() {
  const startDate = document.getElementById("start_date").value;
  const endDate = document.getElementById("end_date").value;

  let q = sb.from("spare_parts_logs").select("*").order("created_at", { ascending: false });

  // 시작일이 입력된 경우
  if (startDate) {
    // 시작일의 00시 00분 00초부터
    q = q.gte("created_at", startDate + "T00:00:00");
  }

  // 종료일이 입력된 경우
  if (endDate) {
    // 종료일의 23시 59분 59초까지
    q = q.lte("created_at", endDate + "T23:59:59");
  }

  const { data, error } = await q;

  if (error) {
    console.error("로그 조회 에러:", error);
    return;
  }

  const logList = document.getElementById("all_log_list");
  logList.innerHTML = "";
  
  data.forEach(l => {
    const tClass = l.type === "IN" ? "type-in" : "type-out";
    const tText = l.type === "IN" ? "입고" : "출고";
    logList.innerHTML += `
      <tr>
        <td>${new Date(l.created_at).toLocaleString()}</td>
        <td class="${tClass}">${tText}</td>
        <td>${l.main_category}</td>
        <td>${l.mid_category}</td>
        <td>${l.part_name}</td>
        <td>${l.quantity}</td>
        <td>${l.note ?? ""}</td>
      </tr>`;
  });
}

/* 필터 초기화 함수 */
function resetLogFilter() {
  document.getElementById("start_date").value = "";
  document.getElementById("end_date").value = "";
  loadAllLogs(); // 전체 다시 불러오기
}
  
/* 1. 현재 재고 검색 초기화 */
function resetSearch() {
  console.log("재고 검색 초기화 실행"); // 작동 확인용 로그
  const searchInput = document.getElementById("search");
  if (searchInput) {
    searchInput.value = "";
  }
  loadParts(); // 원래 목록 불러오기 함수 실행
}

/* 2. 입출고 이력 날짜 필터 초기화 */
function resetLogFilter() {
  console.log("이력 필터 초기화 실행"); // 작동 확인용 로그
  const start = document.getElementById("start_date");
  const end = document.getElementById("end_date");
  if (start) start.value = "";
  if (end) end.value = "";
  loadAllLogs(); // 전체 이력 불러오기 함수 실행
}

/* 3. 테이블 정렬 함수 (틀 고정 호환 버전) */
function sortTable(tableId, colIdx, isNumber = false) {
  const table = document.getElementById(tableId);
  const rows = Array.from(table.querySelectorAll("tr"));
  const isAsc = table.getAttribute("data-sort-dir") !== "asc";
  
  rows.sort((a, b) => {
    let valA = a.children[colIdx].innerText;
    let valB = b.children[colIdx].innerText;

    if (isNumber) {
      return isAsc ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
    } else {
      return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
    }
  });

  rows.forEach(row => table.appendChild(row));
  table.setAttribute("data-sort-dir", isAsc ? "asc" : "desc");

  // 헤더 화살표 표시
  const headers = table.closest('table').querySelectorAll('th');
  headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
  headers[colIdx].classList.add(isAsc ? 'sort-asc' : 'sort-desc');
}

/* 4. 엔터키 검색 지원 */
document.getElementById("search").addEventListener("keypress", function(e) {
  if (e.key === "Enter") {
    loadParts();
  }
});

/* 테이블 데이터를 엑셀로 변환하여 다운로드 (열 너비 수정 버전) */
async function downloadExcel(tableBodyId, fileName) {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('Sheet1');
  const table = document.getElementById(tableBodyId).closest('table');
  
  // 1. 헤더 추출 및 스타일 적용
  const headerRow = [];
  table.querySelectorAll('thead th').forEach(th => headerRow.push(th.innerText));
  const sheetHeader = worksheet.addRow(headerRow);
  
  sheetHeader.eachCell((cell) => {
    cell.fill = {
      type: 'pattern',
      pattern: 'solid',
      fgColor: { argb: 'FF1E3A8A' } // 남색 배경
    };
    cell.font = {
      color: { argb: 'FFFFFFFF' }, // 흰색 글자
      bold: true
    };
    cell.alignment = { vertical: 'middle', horizontal: 'center' };
  });

  // 2. 데이터 추출
  table.querySelectorAll(`tbody#${tableBodyId} tr`).forEach(tr => {
    const rowData = [];
    tr.querySelectorAll('td').forEach(td => rowData.push(td.innerText));
    worksheet.addRow(rowData);
  });

  // 3. 열 너비 설정
  worksheet.columns = tableBodyId === 'list' 
    ? [{width:20}, {width:20}, {width:30}, {width:10}, {width:20}, {width:30}]
    : [{width:25}, {width:10}, {width:20}, {width:20}, {width:30}, {width:10}, {width:30}];

  // 4. 파일 저장
  const buffer = await workbook.xlsx.writeBuffer();
  const today = new Date().toISOString().slice(0, 10);
  saveAs(new Blob([buffer]), `${fileName}_${today}.xlsx`);
}

// 우리 사업소 전용 ID/PW 설정
const MASTER_ID = "bio_admin";  // 사용할 아이디
const MASTER_PW = "bio0213!"; // 사용할 비밀번호

// 설정: 자동 로그아웃 시간 (30분 = 30 * 60 * 1000 밀리초)
const INACTIVITY_TIME = 30 * 60 * 1000; 
let logoutTimer;

// 1. 로그인 체크 함수 (상태 유지 기능 추가)
function checkLogin() {
  const id = document.getElementById("login-id").value;
  const pw = document.getElementById("login-pw").value;
  const msg = document.getElementById("login-msg");

  if (id === MASTER_ID && pw === MASTER_PW) {
    // 로그인 성공 시 세션 저장소에 '로그인 됨' 상태와 현재 시간 기록
    sessionStorage.setItem("isLoggedIn", "true");
    sessionStorage.setItem("lastActivity", Date.now());
    
    document.getElementById("login-overlay").style.display = "none";
    resetLogoutTimer(); // 타이머 시작
  } else {
    msg.innerText = "아이디 또는 비밀번호가 틀렸습니다.";
  }
}

// 2. 페이지 로드 시 로그인 상태 확인 (F5 눌러도 유지됨)
window.onload = function() {
  const isLoggedIn = sessionStorage.getItem("isLoggedIn");
  const lastActivity = sessionStorage.getItem("lastActivity");
  const now = Date.now();

  // 로그인 상태이고, 마지막 활동으로부터 30분이 지나지 않았을 때
  if (isLoggedIn === "true" && (now - lastActivity < INACTIVITY_TIME)) {
    document.getElementById("login-overlay").style.display = "none";
    sessionStorage.setItem("lastActivity", now); // 활동 시간 갱신
    resetLogoutTimer();
  }
  
  // 기존에 있던 초기 데이터 로드 함수들 실행
  loadMainCategory(); 
  loadParts(); 
  loadOutParts(); 
  loadAllLogs();
};

// 3. 자동 로그아웃 관련 함수
function resetLogoutTimer() {
  clearTimeout(logoutTimer);
  // 마지막 활동 시간 갱신
  sessionStorage.setItem("lastActivity", Date.now());
  // 30분 뒤에 로그아웃 실행
  logoutTimer = setTimeout(logout, INACTIVITY_TIME);
}

function logout() {
  sessionStorage.clear(); // 세션 정보 삭제
  alert("장시간 활동이 없어 안전을 위해 로그아웃되었습니다.");
  location.reload(); // 페이지 새로고침하여 로그인 창 띄우기
}

// 4. 마우스 움직임이나 클릭이 있으면 타이머를 초기화 (활동 중으로 간주)
window.onmousemove = resetLogoutTimer;
window.onkeypress = resetLogoutTimer;
window.onclick = resetLogoutTimer;

// 엔터 키로도 로그인 가능하게 설정
document.getElementById("login-pw").addEventListener("keypress", function(e) {
  if (e.key === "Enter") checkLogin();
});

  

/* 5. 페이지 시작 시 실행 */
loadMainCategory(); 
loadParts(); 
loadOutParts(); 
loadAllLogs();
</script>
</body>
</html>
