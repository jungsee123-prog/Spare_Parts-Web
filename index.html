<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>예비품 재고 관리</title>

  <!-- Supabase CDN -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 6px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h2>예비품 재고 관리</h2>

<!-- 검색 -->
<input id="search" placeholder="예비품명 검색" />
<button onclick="loadParts()">검색</button>

<hr />

<!-- 입고 -->
<h3>입고 등록</h3>

<select id="main_category" onchange="updateMidCategory()">
  <option value="">대분류 선택</option>
</select>

<select id="mid_category">
  <option value="">중분류 선택</option>
</select>

<input id="part_name" placeholder="예비품명" />
<input id="quantity" type="number" placeholder="수량" />
<input id="location" placeholder="보관 위치" />
<input id="note" placeholder="비고" />

<button onclick="savePart()">입고 저장</button>

<hr />

<!-- 출고 -->
<h3>출고 처리</h3>

<select id="out_part_id">
  <option value="">출고 예비품 선택</option>
</select>

<input id="out_quantity" type="number" placeholder="출고 수량" />
<input id="out_note" placeholder="비고" />

<button onclick="outPart()">출고 처리</button>

<hr />

<!-- 재고 목록 -->
<h3>현재 재고</h3>
<table>
  <thead>
    <tr>
      <th>대분류</th>
      <th>중분류</th>
      <th>예비품명</th>
      <th>수량</th>
      <th>보관 위치</th>
      <th>비고</th>
    </tr>
  </thead>
  <tbody id="list"></tbody>
</table>

<hr />

<!-- 출고 이력 -->
<h3>출고 이력</h3>
<table>
  <thead>
    <tr>
      <th>출고일</th>
      <th>대분류</th>
      <th>중분류</th>
      <th>예비품명</th>
      <th>출고수량</th>
      <th>비고</th>
    </tr>
  </thead>
  <tbody id="out_log_list"></tbody>
</table>

<script>
/* ===== Supabase ===== */
const SUPABASE_URL = "https://tgkwhchuoxuvitnsaqjo.supabase.co";
const SUPABASE_KEY = "sb_publishable_EhWgQhfjCTAdrWTQRUPYKg_c-UU2m2y";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== 분류 ===== */
const CATEGORIES = {
  "반입및전처리설비": ["유압유니트", "스크류컨베이어"],
  "탈수설비": ["벨트프레스", "원심탈수기"]
};

/* ===== 대분류 ===== */
function loadMainCategory() {
  const sel = document.getElementById("main_category");
  for (const k in CATEGORIES) {
    sel.innerHTML += `<option value="${k}">${k}</option>`;
  }
}

/* ===== 중분류 ===== */
function updateMidCategory() {
  const main = document.getElementById("main_category").value;
  const mid = document.getElementById("mid_category");
  mid.innerHTML = '<option value="">중분류 선택</option>';
  if (!main) return;
  CATEGORIES[main].forEach(m => {
    mid.innerHTML += `<option value="${m}">${m}</option>`;
  });
}

/* ===== 재고 조회 ===== */
async function loadParts() {
  const keyword = document.getElementById("search").value;
  let q = sb.from("spare_parts").select("*").order("created_at", { ascending:false });
  if (keyword) q = q.ilike("part_name", `%${keyword}%`);
  const { data } = await q;
  const tbody = document.getElementById("list");
  tbody.innerHTML = "";
  data.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.main_category}</td>
        <td>${r.mid_category}</td>
        <td>${r.part_name}</td>
        <td>${r.quantity}</td>
        <td>${r.location}</td>
        <td>${r.note ?? ""}</td>
      </tr>`;
  });
}

/* ===== 입고 ===== */
async function savePart() {
  const row = {
    main_category: main_category.value,
    mid_category: mid_category.value,
    part_name: part_name.value,
    quantity: Number(quantity.value),
    location: location.value,
    note: note.value
  };
  const { error } = await sb.from("spare_parts").insert([row]);
  if (error) return alert(error.message);
  alert("입고 완료");
  loadParts();
  loadOutParts();
}

/* ===== 출고 드롭다운 ===== */
async function loadOutParts() {
  const sel = document.getElementById("out_part_id");
  sel.innerHTML = '<option value="">출고 예비품 선택</option>';
  const { data } = await sb
    .from("spare_parts")
    .select("id, main_category, mid_category, part_name, quantity")
    .gt("quantity", 0);
  data.forEach(p => {
    sel.innerHTML += `<option value="${p.id}">
      ${p.part_name} (${p.main_category}/${p.mid_category}) [재고:${p.quantity}]
    </option>`;
  });
}

/* ===== 출고 처리 ===== */
async function outPart() {
  const id = Number(out_part_id.value);
  const qty = Number(out_quantity.value);
  if (!id || qty <= 0) return alert("출고 정보 확인");

  const { data } = await sb.from("spare_parts").select("quantity").eq("id", id).single();
  if (data.quantity < qty) return alert("재고 부족");

  await sb.from("spare_parts").update({ quantity: data.quantity - qty }).eq("id", id);
  await sb.from("spare_parts_logs").insert([
    { part_id: id, type: "OUT", quantity: qty, note: out_note.value }
  ]);

  alert("출고 완료");
  loadParts();
  loadOutParts();
  loadOutLogs();
}

/* ===== 출고 이력 ===== */
async function loadOutLogs() {
  const { data } = await sb
    .from("spare_parts_logs")
    .select(`
      quantity, note, created_at,
      spare_parts ( main_category, mid_category, part_name )
    `)
    .eq("type", "OUT")
    .order("created_at", { ascending:false });

  const tbody = document.getElementById("out_log_list");
  tbody.innerHTML = "";
  data.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${new Date(r.created_at).toLocaleString()}</td>
        <td>${r.spare_parts?.main_category ?? ""}</td>
        <td>${r.spare_parts?.mid_category ?? ""}</td>
        <td>${r.spare_parts?.part_name ?? ""}</td>
        <td>${r.quantity}</td>
        <td>${r.note ?? ""}</td>
      </tr>`;
  });
}

/* ===== 최초 실행 ===== */
loadMainCategory();
loadParts();
loadOutParts();
loadOutLogs();
</script>

</body>
</html>
